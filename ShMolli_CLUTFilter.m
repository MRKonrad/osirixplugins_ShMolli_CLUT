//
//  ShMolli_CLUTFilter.m
//  ShMolli_CLUT
//
//  Copyright (c) 2014 Konrad Werys. All rights reserved.
//


#import "ShMolli_CLUTFilter.h"

@implementation ShMolli_CLUTFilter

- (void) initPlugin
{
}

- (long) filterImage:(NSString*) menuName
{
    
//// values from T1mapBlueGreenRed_norm1198SD175.pal, every 16th value
//    unsigned char red[] = {0,158,153,148,143,138,133,128,123,118,113,108,103,98,93,88,83,78,72,67,62,57,55,52,49,46,43,41,38,35,32,29,27,24,21,18,15,13,10,7,4,1,0,0,0,0,0,1,1,2,2,3,3,4,4,4,5,5,5,6,6,6,7,7,7,7,6,5,4,3,2,2,1,0,0,1,17,33,49,64,80,96,112,127,143,159,172,176,181,186,191,195,200,205,210,214,219,223,226,229,232,235,238,240,243,246,249,252,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,253,252,251,250,249,248,247,246,245,244,243,242,241,240,239,237,236,235,234,233,232,231,230,229,228,227,226,225,224,223,222,221,220,219,217,216,215,214,213,212,211,210,209,208,207,206,205,204,203,202,201,200,199,197,196,195,194,193,192,191,190,189,188,187,186,185,184,183,182,181,180,179,177,176};
//    unsigned char green[] = {0,200,195,189,183,178,172,166,160,155,149,143,138,132,126,121,115,109,103,98,92,86,82,78,74,70,65,61,57,53,49,45,40,36,32,28,24,19,15,11,7,3,0,11,24,37,50,62,75,88,101,114,126,139,147,156,164,173,181,189,198,206,215,223,231,233,235,237,239,241,243,245,248,250,252,253,251,249,247,245,243,240,238,236,234,232,228,220,212,203,195,186,178,170,161,153,144,135,122,109,96,83,71,58,45,32,19,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3};
//    unsigned char blue[] = {0,247,247,248,248,248,249,249,249,250,250,250,251,251,251,252,252,252,253,253,253,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,251,248,245,242,239,236,234,231,228,225,222,217,213,208,203,198,194,189,184,179,175,169,153,137,121,106,90,74,58,43,27,11,0,0,1,2,3,5,6,7,8,9,11,11,11,10,9,8,8,7,6,5,5,4,3,3,2,2,2,1,1,0,0,0,0,0,0,1,2,3,4,5,6,8,9,10,11,12,13,14,15,16,17,18,19,20,22,23,24,25,26,27,28,29,30,31,32,33,35,36,37,38,39,40,41,42,43,44,45,46,47,49,50,51,52,53,54,55,56,57,58,59,60,62,63,64,65,66,67,68,69,70,71,72,73,74,76,77,78,79,81,84,86,88,91,93,95,98,100,102,105,107,109,112,114,116,119,121,123,126,128,130,133,135,137,140,142,144,147,149,151,154,156,158,161,163,165,168,170,172,175,177,179,182,184,186,189,191,193,196,198,200,203,205,207,210,212,214,217,219,221,224,226,228,231,233,235,238,240,242,245,247,249};
    
//// values from T1mapBlueGreenRed_norm980SD265.pal, every 16th value
    unsigned char red [] = {0,144,126,107,89,71,55,44,34,24,14,4,0,0,0,0,0,0,0,1,1,1,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,6,6,6,6,7,7,7,7,7,7,6,6,5,5,4,3,3,2,2,1,1,0,0,0,0,7,17,28,38,48,59,69,80,90,100,111,121,132,142,152,163,171,174,178,181,184,187,190,193,196,200,203,206,209,212,215,218,222,224,226,228,229,231,233,235,237,239,241,243,244,246,248,250,252,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,254,253,252,251,250,249,247,246,245,244,243,242,241,240,239,238,237,236,235,233,232,231,230,229,228,227,226,225,224,223,222,221,219,218,217,216,215,214,213,212,211,210,209,208,207,205,204,203,202,201,200,199,198,197,196,195,194,193,192,190,189,188,187,186,185,184,183,182,181,180,179,178,176};
    unsigned char green [] = {0,184,164,143,122,101,82,67,52,37,21,6,3,11,20,28,37,45,53,62,70,79,87,96,104,113,121,130,138,144,149,155,160,166,171,177,183,188,194,199,205,210,216,221,227,231,232,234,235,237,238,239,241,242,244,245,246,248,249,250,252,253,252,251,250,248,247,245,244,243,241,240,238,237,236,234,233,232,229,224,218,212,207,201,196,190,185,179,174,168,162,157,151,146,140,133,124,116,107,99,90,82,74,65,57,48,40,31,23,14,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3};
    unsigned char blue [] = {0,248,249,250,251,253,254,254,254,254,254,254,253,251,249,247,245,243,241,239,238,236,234,232,230,228,226,224,223,220,216,213,210,207,204,201,198,194,191,188,185,182,179,176,172,167,156,146,135,125,115,104,94,84,73,63,52,42,32,21,11,0,0,0,1,1,2,3,4,5,5,6,7,8,9,9,10,11,11,11,10,10,9,9,8,8,8,7,7,6,6,5,5,4,4,3,3,3,2,2,2,1,1,1,1,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,9,10,11,12,13,14,15,16,17,19,20,21,22,23,24,25,26,27,28,30,31,32,33,34,35,36,37,38,39,41,42,43,44,45,46,47,48,49,51,52,53,54,55,56,57,58,59,60,62,63,64,65,66,67,68,69,70,71,73,74,75,76,77,78,80,82,85,87,90,92,94,97,99,101,104,106,109,111,113,116,118,121,123,125,128,130,132,135,137,140,142,144,147,149,152,154,156,159,161,164,166,168,171,173,175,178,180,183,185,187,190,192,195,197,199,202,204,206,209,211,214,216,218,221,223,226,228,230,233,235,237,240,242,245,247,249};
    
    // basicly I copied the code from ViewerController.m -endCLUT
    NSMutableDictionary *clutDict		= [[[[NSUserDefaults standardUserDefaults] dictionaryForKey: @"CLUT"] mutableCopy] autorelease];
    NSMutableDictionary *aCLUTFilter	= [NSMutableDictionary dictionary];
    long				i;
    NSMutableArray		*rArray = [NSMutableArray array];
    NSMutableArray		*gArray = [NSMutableArray array];
    NSMutableArray		*bArray = [NSMutableArray array];
    for( i = 0; i < 256; i++) [rArray addObject: [NSNumber numberWithLong: red[ i]]];
    for( i = 0; i < 256; i++) [gArray addObject: [NSNumber numberWithLong: green[ i]]];
    for( i = 0; i < 256; i++) [bArray addObject: [NSNumber numberWithLong: blue[ i]]];
    
    [aCLUTFilter setObject:rArray forKey:@"Red"];
    [aCLUTFilter setObject:gArray forKey:@"Green"];
    [aCLUTFilter setObject:bArray forKey:@"Blue"];
    
    [clutDict setObject: aCLUTFilter forKey: @"ShMolli_CLUT"];
    [[NSUserDefaults standardUserDefaults] setObject: clutDict forKey: @"CLUT"];
    
    [[NSNotificationCenter defaultCenter] postNotificationName: OsirixUpdateCLUTMenuNotification object: [viewerController curCLUTMenu] userInfo: [NSDictionary dictionary]];
    
    [viewerController ApplyCLUTString:@"ShMolli_CLUT"];
    
    // nice message
    NSAlert *myAlert = [NSAlert alertWithMessageText:@"ShMolli Color Look Up Table" defaultButton:@"OK" alternateButton:nil otherButton:nil informativeTextWithFormat:@"ShMolli Color Look Up Table added, check your CLUT list."];
    [myAlert runModal];
    
    return 0;
}

@end
